\section{Background}

\subsection{Nonlinear Correctors}

Due to the high $\beta$-functions around the experimental IPs, 
the optics of the LHC and HL-LHC are very sensitive to field imperfections in the surrounding triplets.
To compensate for these errors locally, both sides of the LHC IRs hosting experiments 
(ATLAS in IR1, ALICE in IR2, CMS in IR5 and LHCb in IR8) are equipped with linear and non-linear corrector packages.
As shown in the schematics of \cref{fig:irregionlhc,fig:irregionhllhc}, 
these packages are located within the common aperture region of the machines, between Q3 and the separation dipoles D1,
and hence contain common magnets for the two beams. 
Any correction should therefore take the optics of both beams into account.

In the experimental IRs of the LHC and in HL-LHC IR2 and IR8, nonlinear correctors for
skew and normal sextupoles ($a_3, b_3$), skew and normal octupoles ($a_4, b_4$) 
and normal dodecapoles ($b_6$) are available.
In IR1 and IR5 in the HL-LHC on the other hand, the corrector package will be upgraded to 
also include skew and normal decapoles ($a_5, b_5$) as well as skew dodecapoles ($a_6$)
and offer therefore a wider range of field errors to correct, to account for the 
increase in the $\beta$-function in this high-performance 
machine~\cite{BejarAlonsoHighLuminosityLargeHadron2020,DeMariaHighLuminosityLHC2019,BuffatOpticsMeasurementCorrection2022}.


The correctors \ttt{MCSSX.3L2, MCOX.3L2, MCOSX.3L2, MCOSX.3L1} have not been present in LHC Run 2 and Run 3.
These are the skew sextupole, octupole and skew ocupole correctors left of IP2 (possibly due to a hit from a pilot beam), 
as well as the skew octupole corrector left of IP1 (probably due to powering issues).
Their absence is already reflected in the lattice used for simulations \cite{DeMariaCERNOpticsRepository}.
% MCSSX.3L2:MCSSX_UNPLUGGED,   
% MCOX.3L2:MCOX_UNPLUGGED,     
% MCOSX.3L2:MCOSX_UNPLUGGED,   
% MCOSX.3L1:MCOSX_UNPLUGGED,   


\begin{figure}[h!]
    \centering
    \includegraphics[height=2.5cm]{ir_lhc.pdf}
    \caption{Schematic of the right hand side of a LHC IR region and HL-LHC IR2 and IR8.
    Q1, Q2a/b and Q3 are the triplet quadrupoles.
    C0-C3 show the corrector packages with the field order to be corrected indicated. 
    The blue lines mark common cryostats. 
    The non-linear corrector package is included with the orbit correctors in C3.
    }
    \label{fig:irregionlhc}
\end{figure}


\begin{figure}[h!]
    \centering
    \includegraphics[width=\textwidth]{ir_hllhc.pdf}
    \caption{Schematic of the right hand side of HL-LHC IR1 and IR5.
    Q1a/b, Q2a/b and Q3a/b are the triplet quadrupoles. 
    C0, C1, C2 and CP show the corrector packages with the field order to be corrected indicated. 
    The blue lines mark common cryostats. 
    }
    \label{fig:irregionhllhc}
\end{figure}


\subsection{Resonance Driving Terms}

The transformation of the phase-space coordinates of a particle propagating through a circular accelerator 
can be described by means of maps, each describing the transformation generated by an element of the machine.
These maps are symplectic, i.e. they preserve phase-space volume, and can be combined, describing the propagation 
through multiple parts of the accelerator~\cite{DragtLieSeriesInvariant1976}, for example one complete turn. 

Using Lie-Algebra notation~\cite{DragtLieSeriesInvariant1976, DragtLieAlgebraicTheory1982}
%
\begin{equation}
    \label{eq:LieOperator}
    :f: = \sum\limits_{z=x,y} \frac{\partial f}{\partial z} \frac{\partial }{\partial p_z} - \frac{\partial f}{\partial p_z} \frac{\partial }{\partial z}
\end{equation}
%
a linear one turn map $\mathcal{M}$ can be transformed into a rotation $R$, its normal form:
\begin{equation}
    \label{eq:NormalizedTransformation}
    \mathcal{M} = e^{:h:}R  \; .
\end{equation}
%
In case of nonlinear elements present in the machine, the transformation becomes~\cite{ForestHamiltonianFreeDescription1990}:
\begin{equation}
    \label{eq:NormalFormTransformation}
    \mathcal{M} = e^{-:F:} \;  e^{:h:}R \; e^{:F:} \; .
\end{equation}

This transformation depends on the location $s$ at which the one-turn-map is calculated.
Truncating the exponential series at first order, it can be shown~\cite{TomasDirectMeasurementResonance2003} that
%
\begin{equation}
    \label{eq:hamiltonianTwissCoordinates}
    h(s) = \sum\limits_{jklm} h_{jklm}(s) \; (2J_x)^{\frac{j+k}{2}}(2J_y)^{\frac{l+m}{2}} e^{-i\left[(j-k)(\phi_x(s) + \phi_{x,0}) + (l-m)(\phi_y(s) + \phi_{y,0})\right]} \; ,
\end{equation}
%
with $\phi_{z}(s)$ being the phase in plane $z=x,y$ at $s$ and $\phi_{z, 0}$ the initial phase of the particle at injection.
$J$ is the action, i.e. the invariant of (linear) motion~\cite{CourantTheoryAlternatinggradientSynchrotron1958} and $h_{jklm}$ are the 
Hamiltonian coefficients~\cite{TomasDirectMeasurementResonance2003}, which 
are defined by all sources around the ring of multipole order $n = j + k + l + m$ (see \cref{sec:CorrectionPrinciple}).

The contribution $h_{jklm}$ from multipole sources of order $n \geq 2$ to the hamiltionian is given in 
\cite{FranchiStudiesMeasurementsLinear2006} Eq.~(3.11) as 
%
\begin{equation}
    \label{eq:HamiltonianTermsMultipoleSources}
    h_{jklm}(s) = 
    -\ReOf{    
     \frac{i^{l+m}}{j! \, k! \, l! \, m! \, 2^{j+k+l+m}}
    \beta_x(s)^{\frac{j+k}{2}}\beta_y(s)^{\frac{l+m}{2}} 
    \left(K_{n}(s) + iJ_{n}(s)\right)
     } \; .
\end{equation}
%
$K_n(s)$ and $J_n(s)$ are the magnetic field strengths of order $n$ at location $s$ of normal and skew fields respectively.
In this note, we use the convention of \textbf{starting the index $n$ at $1$, representing dipole fields} 
($n=2$ for quadrupole fields, etc.)

Similarly to $h(s)$, $F(s)$ is calculated as 
%
\begin{equation}
    \label{eq:NormalFormGeneratingFunction}
    F(s) = \sum\limits_{jklm} f_{jklm}(s) (2I_x)^{\frac{j+k}{2}}(2I_y)^{\frac{l+m}{2}} e^{-i\left[(j-k)(\psi_x(s) + \psi_{x,0}) + (l-m)(\psi_y(s) + \psi_{y,0})\right]} \; ,
\end{equation}
% 
with $I_z$ and $\psi_z$ being the action and angle coordinates of the nonlinear motion (called canonical coordinates of the normal form).
The generating terms $f_{jklm}$ of $F$ are the so called Resonance Driving Terms (RDTs) and it is shown 
in~\cite{ForestHamiltonianFreeDescription1990} (also given in \cite{FranchiStudiesMeasurementsLinear2006} Eq. (3.15)) that their relation to the hamiltonian terms is
%
\begin{equation}
    \label{eq:RDTHamiltonianRelation}
    f_{jklm}(s) = 
    \oint\limits_{\text{Ring}} \frac{h_{jklm}(s') \; (2J_x)^{\frac{j+k}{2}}(2J_y)^{\frac{l+m}{2}} 
    e^{-i\left[(j-k)\cdot\Delta\phi_x(s, s') + (l-m)\cdot\Delta\phi_y(s, s')\right]}}{1 - e^{-i2\pi[(j-k)Q_x + (l-m)Q_y]}} \;  \rm{d}s' \;.
\end{equation}
%
$\Delta\phi_z(s, s')$ is the phase advance in plane $z = x, y$ between $s$ and $s'$,
 while $Q_z$ are the horizontal and vertical tunes, i.e. the number of betatron oscillations per turn.


In case of the condition 
%
\begin{equation}
    \label{eq:ResonanceCondition}
    (j-k) \cdot Q_x + (l-m) \cdot Q_y = 2\pi \cdot p 
\end{equation}
%
being fulfilled for $p \in \mathbb{Z}$, $f_{jklm}$ diverges, if there are sources present for that order.
In this case the system is in a resonant state, and hence instable.
The behaviour of the instability as the systems approaches the resonance condition therefore depends 
on the strength of the multipole sources present in the machine.
Resonances labeled ($n_x$, $n_y$) are driven by all terms $n_x = j-k$ and $n_y = l - m$.

For each resonance ($n_x$, $n_y$) there is a line in the spectrum obtained by turn-by-turn beam position measurements,
which can be found at $-(n_x-1) \cdot Q_x - n_y \cdot Q_y$ (label: $(-n_x+1, -n_y)$)   in the spectrum of the horizontal plane 
and $-n_x \cdot Q_x - (n_y - 1) \cdot Q_y$ (label: $(-n_x, -n_y+1)$) in the spectrum of the vertical plane~\cite{FranchiStudiesMeasurementsLinear2006}.
The amplitude of these lines is proportional to $\left| f_{jklm} (s) \right|$~\cite{FranchiStudiesMeasurementsLinear2006},
the terms are therefore easily accessible from measurements~\cite{SchmidtMeasurementDrivingTerms2001,TomasDirectMeasurementResonance2003,TomasMeasurementGlobalLocal2005,FranchiFirstSimultaneousMeasurement2014,CarlierObservationsResonanceDriving2016}.

The $h_{jklm}$, and therefore $f_{jklm}$, are constant along $s$ until a multipole source of corresponding order is encountered,
at whose location its value jumps, which makes them very well suited as local observables~\cite{TomasMeasurementGlobalLocal2005}.
The correction algorithm presented here is based on locally minimizing the RDTs in the IR as shown in the next section. 

\subsection{Correction Principle}
\label{sec:CorrectionPrinciple}
 
In this section the correction principle as implemented in
the flexible correction algorithm v1.0.0 in~\cite{OMC-TeamIRNLRDTCorrection} is described.
The algorithm follows the simplifications of \cref{eq:HamiltonianTermsMultipoleSources,eq:RDTHamiltonianRelation} 
as outlined in~\cite{BruningDynamicApertureStudies2004}:

\begin{mytemize}
    \item Only the contribution from elements in one IR to the RDTs are minimized.
          The integral in \cref{eq:RDTHamiltonianRelation} includes therefore only IR elements.
    \item Constant coefficients of \cref{eq:RDTHamiltonianRelation} are ignored, 
          i.e. the numerator and actions as well as the coefficients depending only on $j,k,l,m$ and any signs,
          as they are not needed for minimization, .
    \item The phase of one side of the IR is approximately constant, as \\
          $\Delta \Phi(a,b) = \int\limits_a^b \frac{1}{\beta(s)} \rm{d}s$  
          and $\beta(s)$ being very large in the triplets. 
    \item The phase-advance between the left and right side of the IP is $\pi$. 
    \item The RDT is evaluated locally at the entrance of the IR. 
\end{mytemize}

With these approximations \cref{eq:RDTHamiltonianRelation} becomes an \textit{effective} RDT to minimize:
%
\begin{equation}
    \label{eq:effectiveRDT}
    f^\text{IR}_{jklm} =  \int\limits_\text{IR} 
    \ReOf{    
     i^{l+m}
     \left(K_{n}(s) + iJ_{n}(s) \right) 
    }
        \beta_x(s)^{\frac{j+k}{2}}
        \beta_y(s)^{\frac{l+m}{2}} 
     e^{i \pi n \theta(s - s_\text{IP})}
    \rm{d}s \; ,
\end{equation}
%
with $\theta(x)$ being the heaviside step function and $s_\text{IP}$ the location of 
the IP within the IR.
The $n$ in the exponent replaces $j - k + l - m = n - 2k - 2l$, 
as for even (odd) n, this value will also be even (odd), 
independent of the particular choices for $j,k,l,m$.

The main concept of the correction is then to find the $K_n(s)$ and $J_n(s)$ of 
the corrector magnets, that minimize a set of given $f^\text{IR}_{jklm}$ based on given optics.

As there are usually two correctors per multipole field available (one on each side of the IP), 
two combinations of $l+m$ and $j+k$ (the exponents of the $\beta$ function)
can be corrected.
As the correctors are responsible for the correction of both beams, 
the exponents need to be chosen such that the correction is valid for both beams, 
which means that only a single RDT per beam can be corrected 
unless the symmetry of the optics can be used to correct
two RDTs (see \cref{sec:DualOptics}).

In the LHC $a_3, b_3, a_4, b_4$ and $b_6$ correctors are available,
in the HL-LHC additionally $a_5, b_5$ and $a_6$.


\subsubsection{Equation System}

In our simulations, the input to the correction algorithm will be the output 
of \ttt{TWISS} and \ttt{ESAVE} functions from \ttt{MAD-X}~\cite{CERNMadX}.
These are tables in which $K_n(s)$ and $J_n(s)$ are not continuous functions, 
but given as already integrated values $K_nL_w$, $J_nL_w$ 
(\ttt{K$_{n-1}$L}, \ttt{K$_{n-1}$SL} in the terminology of \ttt{MAD-X}) for each element $w$.
Values for the longitudinal position $s_w$, $\beta_{x,w}, \beta_{x,w}$ and the transversal orbit $x_w, y_w$, which will be important 
when calculating feed-down (see below), are also provided.


To assure aa accurate estimate for the integral in \cref{eq:effectiveRDT}, 
the lattice should be \textit{sliced} in \ttt{MAD-X}, 
i.e. all magnets are approximated by single kicks surrounded by drift-spaces. 
Long magnets should be cut into multiple of these slices to increase accuracy. 
Corrector magnets on the other hand, which are in any case short compared to e.g. dipoles, 
can  be represented by a single slice.

In this thin-lens approximation, \cref{eq:effectiveRDT} transforms into a sum over all elements (slices) $w$ in the IR, 
which needs to be set to zero to suppress the RDT:
 %
\begin{equation}
    \label{eq:effectiveRDTSum}
    f^\text{IR}_{jklm} =  \sum\limits_{w \in \text{IR}} 
    \ReOf{    
     i^{l+m}
     \left(K_{n}L_w + iJ_{n}L_w \right) 
    }
        \beta_{x,w}^{\frac{j+k}{2}}
        \beta_{y,w}^{\frac{l+m}{2}} 
     e^{i \pi n \theta(s_w - s_\text{IP})} 
     \overeq{!} 0 
     \; .
\end{equation}
%

Splitting the elements into corrector elements $\mathcal{C}$ and non-corrector elements $\text{IR}\setminus\mathcal{C}$,
\cref{eq:effectiveRDTSum} transforms into:
 %
\begin{equation}
    \label{eq:equationSum}
    \begin{split}
    &\sum\limits_{w \in \mathcal{C}} 
    \ReOf{    
     i^{l+m}
     \left(K_{n}L_w + iJ_{n}L_w \right) 
    }
        \beta_{x,w}^{\frac{j+k}{2}}
        \beta_{y,w}^{\frac{l+m}{2}} 
     e^{i \pi n \theta(s_w - s_\text{IP})} \\
     = 
    -&\sum\limits_{w \in \text{IR}\setminus\mathcal{C}} 
    \ReOf{  
     i^{l+m}
     \left(K_{n}L_w + iJ_{n}L_w \right) 
    }
        \beta_{x,w}^{\frac{j+k}{2}}
        \beta_{y,w}^{\frac{l+m}{2}} 
     e^{i \pi n \theta(s_w - s_\text{IP})} 
    \end{split}
     \; ,
\end{equation}

It is important to note, that each corrector is defined by either
$K_nL$ or $J_nL$, so that per order $n$ and orientation (normal, skew) only a limited set of 
correctors is left.
Normally there are two of these correctors in the LHC/HL-LHC, i.e. one per IP side,
and $\mathcal{C} = \{cl, cr\}$, a left ($cl$) and a right ($cr$) corrector element.
Defining the sum over IR$\setminus\mathcal{C}$ in \cref{eq:equationSum}
as $I_{jklm}$ and
\begin{equation}
    \label{eq:BcomponentsDef}
    \begin{split}
    b_{jklm}^{(cl)} &= 
     \hphantom{(-1)^n} \, i^{l+m} \,
     \beta_{x,cl} ^{\frac{j+k}{2}} \beta_{y,cl}^{\frac{l+m}{2}} 
    \\
    b_{jklm}^{(cr)} &= 
     (-1)^n\, i^{l+m} \, 
     \beta_{x,cr} ^{\frac{j+k}{2}} \beta_{y,cl}^{\frac{l+m}{2}} \; ,
    \end{split}
\end{equation}
%
\cref{eq:equationSum} can be split into a two equation system 
%
\begin{equation}
    \label{eq:linearEqSystemSingle}
    \begin{split}
        \begin{pmatrix}
            b_{jklm}^{(cl)} & b_{jklm}^{(cr)}
        \end{pmatrix}
        \begin{pmatrix}
            K_{n}L_{cl} \\ 
            K_{n}L_{cr}
        \end{pmatrix}
        &= - I_{jklm}
        \qquad \text{if } l+m \text{ even},
        \\
        \begin{pmatrix}
            i \, b_{jklm}^{(cl)} & i \, b_{jklm}^{(cr)}
        \end{pmatrix}
        \begin{pmatrix}
            J_{n}L_{cl} \\ 
            J_{n}L_{cr}
        \end{pmatrix}
        &= - I_{jklm}
        \qquad  \text{if } l+m \text{ odd}, 
    \end{split}
\end{equation}
%
which can be easily extended to include multiple RDTs, e.g.:
\begin{equation}    
    \label{eq:linearEqSystemDouble}
        \begin{pmatrix}
            b_{jklm}^{(cl)} & b_{jklm}^{(cr)} \\
            b_{j'k'l'm'}^{(cl)} & b_{j'k'l'm'}^{(cr)}
        \end{pmatrix}
        \begin{pmatrix}
            K_{n}L_{cl} \\ 
            K_{n}L_{cr}
        \end{pmatrix}
        = - 
        \begin{pmatrix}
            I_{jklm} \\ 
            I_{j'k'l'm'} 
        \end{pmatrix}
\end{equation}
with $j+k+l+m = j'+k'+l'+m' = n$ and $l + m$ and $l'+m'$ both even.
These linear equation systems can be solved or optimized for $K_nL_{cl, cr}$ or $J_nL_{cl, cr}$ by standard algorithms.


\subsubsection{Dual Optics} % --------------------
\label{sec:DualOptics}

% \begin{tikzpicture}
%     \node (start) at (0, 0) {aaa};
%     \node (end) at (1, 1) {bbb};
%     \draw[red, ->]  (start) -- (end);
% \end{tikzpicture}


\begin{figure}[htbp]
    \centering
    \begin{subfigure}{0.35\textwidth}
        % \includegraphics[height=60mm,trim=15 0 160 0, clip]{images/optics/plot.hllhc.round1515.xing_top.beta.IP1.pdf}
        \begin{tikzpicture}[every node/.style={inner sep=1pt,outer sep=0}]
            \node (image) at (current page.center) {\includegraphics[height=60mm, trim=15 0 160 0, clip]{images/optics/plot.hllhc.round1515.xing_top.beta.IP1.pdf}};
            \begin{scope}[shift={(image.south west)},x={(image.south east)},y={(image.north west)}]
            \node (b1start) at (0.238, 0.454){};
            \node (b1)[right= 10pt of b1start] {\tiny Beam 1};
            \node (b1end)[right= 10pt of b1]{};
            \draw[-]  (b1start) -- (b1);
            \draw[->]  (b1) -- (b1end);
            \node (b2start) at (0.94, 0.454){};
            \node (b2)[left= 10pt of b2start] {\tiny Beam 2};
            \node (b2end)[left= 10pt of b2]{};
            \draw[-]  (b2start) -- (b2);
            \draw[->]  (b2) -- (b2end);
            \end{scope}
        \end{tikzpicture}
        \caption{$\beta^* = \qty{15}{cm}$ round optics}
        \label{fig:betaIP1HLLHCround}
    \end{subfigure}
    \begin{subfigure}{0.35\textwidth}
        % \includegraphics[height=60mm, trim=40 0 19 0, clip]{images/optics/plot.hllhc.flat07530.xing_top.beta.IP1.pdf}
        \begin{tikzpicture}[every node/.style={inner sep=1pt,outer sep=0}]
            \node (image) at (current page.center) {\includegraphics[height=60mm, trim=40 0 19 0, clip]{images/optics/plot.hllhc.flat07530.xing_top.beta.IP1.pdf}};
            \begin{scope}[shift={(image.south west)},x={(image.south east)},y={(image.north west)}]
            \node (b1start) at (0.107, 0.454){};
            \node (b1)[right= 10pt of b1start] {\tiny Beam 1};
            \node (b1end)[right= 10pt of b1]{};
            \draw[-]  (b1start) -- (b1);
            \draw[->]  (b1) -- (b1end);
            \node (b2start) at (0.62, 0.454){};
            \node (b2)[left= 10pt of b2start] {\tiny Beam 2};
            \node (b2end)[left= 10pt of b2]{};
            \draw[-]  (b2start) -- (b2);
            \draw[->]  (b2) -- (b2end);
            \end{scope}
        \end{tikzpicture}
        \caption{$\beta^* = \qty{7.5}{cm}/\qty{30}{cm}$ flat optics}
        \label{fig:betaIP1HLLHCflat}
    \end{subfigure}
	\caption{HL-LHC $\beta$-functions in the IR around IP1.}
	\label{fig:betaIP1HLLHC}
\end{figure}

In the original implementation of the algorithm in~\cite{BruningDynamicApertureStudies2004},
the optics of only one beam could be given and the algorithm was making use 
of the symmetries of the $\beta$-function in the IR
%
\begin{equation}
    \label{eq:betaSymmetriesRound}
    \begin{split}
        \beta_x^{\text{(B1)}}(s) &= \beta_y^{\text{(B2)}}(s) \\ 
        \beta_y^{\text{(B1)}}(s) &= \beta_x^{\text{(B2)}}(s) \;, 
    \end{split}
\end{equation}
%
which is true for round optics as shown in~\cref{fig:betaIP1HLLHCround}, to calculate a correction valid for both beams.
With this symmetry the effective RDT \cref{eq:effectiveRDT} simply switches the $\beta$ exponents between the beams, 
for which we will use the notation
%
\begin{equation}
    \label{eq:effectiveRDT*}
    f^\text{IR (B1)}_{jklm*}  
    \quad \overeq{\cref{eq:effectiveRDT}} \quad
    \int\limits_\text{IR} 
    \ReOf{ 
     i^{l+m}
     \left(K_{n}(s) + iJ_{n}(s) \right) 
    }
        \beta_x(s)^{\frac{l+m}{2}}
        \beta_y(s)^{\frac{j+k}{2}} 
     e^{i \pi n \theta(s - s_\text{IP})}
    \rm{d}s 
    \quad \overeq{\cref{eq:betaSymmetriesRound}} \quad
    f^\text{IR (B2)}_{lmjk}\; .
\end{equation}
%
As mentioned in the previous section, with the two correctors per field type (order and orientation),
we can perfectly correct two RDTs locally in the IR. 
When 
%
\begin{equation}
    j+k \equiv l+m \mod{2} \;,
\end{equation}
%
i.e. both $f_{jklm}$ and $f_{lmjk}$ are skew (normal) RDTs, 
two RDTs per beam can be corrected: 
$f^\text{IR}_{jklm*} = \pm f^\text{IR}_{lmjk}$ within the optics of the same beam
and we can therefore choose $f^\text{IR}_{j'k'l'm'}  = f^\text{IR}_{lmjk} (= \pm f^\text{IR}_{jklm*})$ in \cref{eq:linearEqSystemDouble}.
If on the other hand $j+k$ and $l+m$ are of different parity, only \textbf{one} RDT $f^\text{IR}_{jklm}$ per beam can be corrected, 
by targeting $f^\text{IR}_{jklm}$ and $f^\text{IR}_{j'k'l'm'} = f^\text{IR}_{jklm*}$ in the given optics.

There are optics in which \cref{eq:betaSymmetriesRound} does not hold true anymore.
For example, in contrast to \textit{round} optics, 
in which the $\beta$-function  at the IP ($\beta^* = \beta(s_\text{IP})$) is equal for both transversal planes ($\beta^*_x = \beta^*_y$),
there exists also so called \textit{flat} optics, for which $\beta^*_x \neq \beta^*_y$ 
(i.e. the beam shape is \textit{flat} at the IP)~\cite{FartoukhAchromaticTelescopicSqueezing2013,FartoukhFlatTelescopicOptics2018}.
A realization of flat optics, forseen to be used in the HL-LHC, is shown in \cref{fig:betaIP1HLLHCflat}.

The straightforward way to not to rely on \cref{eq:betaSymmetriesRound}, 
is to use the optics for both beams in the correction and construct \cref{eq:linearEqSystemDouble} from both
%
\begin{equation}    
    \label{eq:linearEqSystemDoubleOptics}
        \begin{pmatrix}
            b_{jklm}^{(cl, \text{B1})} & b_{jklm}^{(cr, \text{B1})} \\
            b_{jklm}^{(cl, \text{B2})} & b_{jklm}^{(cr, \text{B2})}
        \end{pmatrix}
        \begin{pmatrix}
            K_{n}L_{cl} \\ 
            K_{n}L_{cr}
        \end{pmatrix}
        = - 
        \begin{pmatrix}
            I^{(\text{B1})}_{jklm} \\ 
            I^{(\text{B2})}_{jklm} 
        \end{pmatrix} 
        \; .
\end{equation}

\subsubsection{Feed-Down} % --------------------

The effect of feed-down occurs whenever a particle beam is passing off-center through a magnet, 
due to either a transverse misalignment of the magnet or an off-center closed orbit of the beam itself.
In these cases, the magnetic field can be described via Taylor expansion as a composition of 
magnetic field components with identical geometry as lower order fields in addition to the current field of higher order. 
These components therefore cause the same effects on the beam 
as lower order sources would~\cite{WiedemannParticleAcceleratorPhysics2015}. 

Feed-down can be understood by applying a first-order Taylor Expansion $x \mapsto x + \Delta x$ and $y \mapsto y + \Delta y$
to \cref{eq:hamiltonianTwissCoordinates} in the 
curvilinear (comoving) coordinate system
%
\begin{equation}
   \label{eq:hamiltonianFeeddownDerivation}
   \begin{split}
   h
   &= \qquad 
   -\ReOf{\sum_{n = 2}^\infty \left(K_n + iJ_n\right)\frac{\left(x+iy\right)^n}{n!}} \\
   &\overeq{Taylor} \qquad
    -\ReOf{
        \sum_{n = 2}^\infty (K_n + iJ_n)
        \frac{\sum\limits_{q=0}^{n} \frac{1}{q!} \frac{n!}{(n-q)!}(x+iy)^{n-q} (\Delta x + i \Delta y)^q}{n!}
    } \\
    &=\qquad
     -\ReOf{
         \sum_{n = 2}^\infty (K_n + iJ_n)
         \sum\limits_{q = 0}^{n} \frac{(x+iy)^{n-q} (\Delta x + i \Delta y)^q}{q!\, (n-q!)} 
      } \\
     &\myoverunder{\text{sort by } (x + iy)^n}{=}{n \mapsto n+q} \qquad
     - \ReOf{
        \sum_{n = 0}^\infty \sum_{\substack{q=0 \text{ if } n \geq 2 \\ q = 2 \text{  if } n < 2 }}^{\infty} \frac{1}{q!\, n!}
        (K_{n+q} + iJ_{n+q}) (x + iy)^n (\Delta x + i \Delta y)^q 
     } \\
     &= \qquad
     - \ReOf{\sum_{n = 0}^\infty 
        \left( \sum_{\substack{q=0 \text{ if } n \geq 2 \\ q = 2 \text{  if } n < 2 }}^{\infty} 
        (K_{n+q} + iJ_{n+q}) \frac{(\Delta x + i \Delta y)^q}{q!} \right)
        \frac{(x + iy)^n}{n!}
     }
   \end{split}
\end{equation}
%
For brevity $(s)$ is omitted, but $h, K_n, J_n, x, y$ and $\Delta x, \Delta y$ are all dependent on the longitudinal location.
From \cref{eq:hamiltonianFeeddownDerivation} one can see that magnetic field strengths
of order $n \geq 2$ without feed-down are replaced by a sum depending  on the deviation of the beam from 
magnet-center and higher order field strengths.
Feed-down to field order $n \geq 2$ from fields up to $n + Q$ can now be calculated by:
%
\begin{equation}
    \label{eq:feeddownOrderN}
    K_n + iJ_n \overset{\text{w/ feeddown}}{\rightarrow} \sum_{q = 0}^{Q} (K_{n+q} + iJ_{n+q}) \frac{(\Delta x + i \Delta y)^q}{q!}.
\end{equation}
%
Fields feed-down can also have an effect on the scalar field ($n = 0$) and dipole fields ($n = 1$).
As their structure does not follow the structure in \cref{eq:hamiltonianTwissCoordinates},
\cref{eq:feeddownOrderN} is not applicable.
In the context of RDTs $n$ is always larger than 2 and we can use \cref{eq:feeddownOrderN} 
in the definition of the effective RDT \cref{eq:effectiveRDT}
%
\begin{equation}
    \label{eq:effectiveRDTfeeddown}
    \small
    f^\text{IR}_{jklm} =  \int\limits_\text{IR} 
    \ReOf{    
     i^{l+m}
     \sum_{q = 0}^{\infty} 
     (K_{n+q}(s) + iJ_{n+q}(s)) \frac{(\Delta x(s) + i \Delta y(s))^q}{q!} 
    }
        \beta_x(s)^{\frac{j+k}{2}}
        \beta_y(s)^{\frac{l+m}{2}} 
     e^{i \pi n \theta(s - s_\text{IP})}
    \rm{d}s \; ,
\end{equation}
%
and can therefore easily include it when building the equation systems 
\cref{eq:linearEqSystemSingle}, \cref{eq:linearEqSystemDouble} or \cref{eq:linearEqSystemDoubleOptics}.

Not only can feed-down be used to calculate the influence of field errors of orders $\geq n$ on the RDT, 
i.e. by contributing to the integral $I_{jklm}$, but it can also be used to calculate the strengths 
of correctors of orders $n_\text{Corrector} > n$ to counteract the RDT via feed-down.
The matrix elements of the corrector coefficients in \cref{eq:BcomponentsDef} will then also contain the feed-down coefficient
%
\begin{equation}
    \label{eq:zpDefinition}
    z_{p} = \frac{\left( \Delta x + i\Delta y\right)^p}{p!} \, \,
\end{equation}
%
with $p$ being the order of feed-down necessary, i.e. 
\begin{equation}
    \label{eq:DiffOrderCorrectorRDT}
    p = n_\text{Corrector} - n \, .
\end{equation}
%
As $z_p \in \mathbb{C}$, this makes the evaluation of the real part in \cref{eq:equationSum}, 
needed to split the equation system into two, separating the correctors (\cref{eq:linearEqSystemSingle}), 
less straightforward and more cases need to be considered.
Inserting
%
\begin{equation}
    \label{eq:KnJnWithZp}
    \begin{split}
        &\ReOf{    
        i^{l+m}
        (K_{n+p}L_w + iJ_{n+p}L_w) \frac{(\Delta xL_w + i \Delta yL_w)^q}{q!} 
        }
        \\
        \overeq{\cref{eq:zpDefinition}} \quad
        &\ReOf{    
        i^{l+m}
        (K_{n+p}L_w + iJ_{n+p}L_w) \cdot z_p 
        }
        \\
        =  \quad
        &\ReOf{    
        i^{l+m}
        (K_{n+p}L_w + iJ_{n+p}L_w) (\ReOf{z_p} + i\ImOf{z_p}) 
        }
        \\
        =  \quad
        &\ReOf{    
        i^{l+m} \left[
        (K_{n+p}L_w \cdot \ReOf{z_p} -J_{n+p}L_w \cdot \ImOf{z_p}) + i(K_{n+p}L_w \cdot \ImOf{z_p} + J_{n+p} \cdot \ReOf{z_p} )\right] 
        }
    \end{split}
\end{equation}
%
into \cref{eq:equationSum} yields the equation system
%
\begin{equation}
    \label{eq:linearEqSystemFeeddown}
    \begin{split}
    \footnotesize
    \begin{pmatrix}
        \ReOf{z_p} \cdot b_{jklm}^{(cl)} & 
        \ReOf{z_p} \cdot b_{jklm}^{(cr)} & 
        -\ImOf{z_p} \cdot b_{jklm}^{(cl)} &
        -\ImOf{z_p} \cdot b_{jklm}^{(cr)}
    \end{pmatrix}
    \begin{pmatrix}
        K_{n+p}L_{cl} \\ 
        K_{n+p}L_{cr} \\ 
        J_{n+p}L_{cl} \\ 
        J_{n+p}L_{cr}
    \end{pmatrix}
     &= -
     I_{jklm} \quad
    \text{for even } l+m, 
     \\
    \footnotesize
    \begin{pmatrix}
        i \,\ImOf{z_p} \cdot b_{jklm}^{(cl)} & 
        i \,\ImOf{z_p} \cdot b_{jklm}^{(cr)} & 
        i \,\ReOf{z_p} \cdot b_{jklm}^{(cl)} & 
        i \,\ReOf{z_p} \cdot b_{jklm}^{(cr)}
    \end{pmatrix}
    \begin{pmatrix}
        K_{n+p}L_{cl} \\ 
        K_{n+p}L_{cr} \\ 
        J_{n+p}L_{cl} \\
        J_{n+p}L_{cr}
    \end{pmatrix}
     &=  
     -I_{jklm} \quad
    \text{for odd } l+m \; .
    \end{split}
\end{equation}
%
In the case of $p = 0$, \cref{eq:linearEqSystemFeeddown} transforms back to \cref{eq:linearEqSystemSingle},
as $\ReOf{z_0} = 1$ and $\ImOf{z_0} = 0$. 
For simplicity, we can redefine $b_{jklm}$ to include the additional factors directly into the coefficients 
\begin{equation}
    \label{eq:coefficientWithFeeddown}
    b_{jklm,p} =
    \begin{cases}
      \phantom{-} \ReOf{z_p} \cdot b_{jklm}   \quad \text{if normal corrector and } l + m \text{ even}, \\
     \phantom{-} \ImOf{z_p} \cdot b_{jklm}    \quad \text{if normal corrector and } l + m \text{ odd}, \\    
      -\ImOf{z_p} \cdot b_{jklm}              \quad \text{if skew corrector and } l + m \text{ even}, \\    
       \phantom{-} \ReOf{z_p}  \cdot b_{jklm} \quad \text{if skew corrector and } l + m \text{ odd} 
    \end{cases}
\end{equation}
%
and take care to take $z_p$ into account, whenever $p>0$.

Including feed-down into the equation system also allows therefore to correct multiple orders of RDTs with the same correctors, 
as well as correcting RDTs with correctors of multiple orders.
\Cref{eq:linearEqSystemSingle} can hence not only be extended ``vertically'' by correcting for multiple beam optics (\cref{eq:linearEqSystemDoubleOptics})
 and different RDTs (\cref{eq:linearEqSystemDouble}) at the same time, 
but also ``horizontally'', by adding more correctors, e.g.
%
\begin{equation}    
    \label{eq:linearEqSystemDoubleCorrectors}
        \begin{pmatrix}
            b_{jklm}^{(cl)} & b_{jklm}^{(cr)} & b_{jklm,p}^{(cl)} & b_{jklm,p}^{(cr)} \\
            b_{j'k'l'm'}^{(cl)} & b_{j'k'l'm'}^{(cr)} & b_{j'k'l'm',p}^{(cl)} & b_{j'k'l'm',p}^{(cr)}
        \end{pmatrix}
        \begin{pmatrix}
            K_{n}L_{cl} \\ 
            K_{n}L_{cr} \\
            K_{n+p}L_{cl} \\ 
            K_{n+p}L_{cr}
        \end{pmatrix}
        = - 
        \begin{pmatrix}
            I_{jklm} \\ 
            I_{j'k'l'm'} 
        \end{pmatrix}
\end{equation}