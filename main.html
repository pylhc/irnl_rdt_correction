<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nonlinear Correction calculation in the IRs &mdash; irnl-rdt-correction 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Constants" href="tools.html" />
    <link rel="prev" title="Welcome the documentation of the IRNL RDT Correction!" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> irnl-rdt-correction
            <img src="_static/omc_logo.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Main</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Nonlinear Correction calculation in the IRs</a></li>
<li class="toctree-l1"><a class="reference internal" href="#irnl_rdt_correction.main.irnl_rdt_correction"><code class="docutils literal notranslate"><span class="pre">irnl_rdt_correction()</span></code></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Constants</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#equation-system">Equation System</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.build_equation_system"><code class="docutils literal notranslate"><span class="pre">build_equation_system()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.get_available_correctors"><code class="docutils literal notranslate"><span class="pre">get_available_correctors()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.get_corrector_coefficient"><code class="docutils literal notranslate"><span class="pre">get_corrector_coefficient()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.get_current_rdt_maps"><code class="docutils literal notranslate"><span class="pre">get_current_rdt_maps()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.get_elements_integral"><code class="docutils literal notranslate"><span class="pre">get_elements_integral()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.get_side_sign"><code class="docutils literal notranslate"><span class="pre">get_side_sign()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.init_corrector_and_optics_values"><code class="docutils literal notranslate"><span class="pre">init_corrector_and_optics_values()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.optics_update"><code class="docutils literal notranslate"><span class="pre">optics_update()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.restore_optics_values"><code class="docutils literal notranslate"><span class="pre">restore_optics_values()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.solve"><code class="docutils literal notranslate"><span class="pre">solve()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.equation_system.solve_equation_system"><code class="docutils literal notranslate"><span class="pre">solve_equation_system()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#input-options">Input Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.input_options.check_opt"><code class="docutils literal notranslate"><span class="pre">check_opt()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#io-handling">IO Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.io_handling.build_correction_df"><code class="docutils literal notranslate"><span class="pre">build_correction_df()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.io_handling.build_correction_str"><code class="docutils literal notranslate"><span class="pre">build_correction_str()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.io_handling.build_correction_str_from_df"><code class="docutils literal notranslate"><span class="pre">build_correction_str_from_df()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.io_handling.get_and_write_output"><code class="docutils literal notranslate"><span class="pre">get_and_write_output()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.io_handling.get_optics"><code class="docutils literal notranslate"><span class="pre">get_optics()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.io_handling.get_tfs"><code class="docutils literal notranslate"><span class="pre">get_tfs()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.io_handling.maybe_switch_signs"><code class="docutils literal notranslate"><span class="pre">maybe_switch_signs()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#rdt-handling">RDT Handling</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.rdt_handling.IRCorrector"><code class="docutils literal notranslate"><span class="pre">IRCorrector</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.rdt_handling.RDT"><code class="docutils literal notranslate"><span class="pre">RDT</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.rdt_handling.check_corrector_order"><code class="docutils literal notranslate"><span class="pre">check_corrector_order()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.rdt_handling.get_needed_orders"><code class="docutils literal notranslate"><span class="pre">get_needed_orders()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.rdt_handling.sort_rdts"><code class="docutils literal notranslate"><span class="pre">sort_rdts()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#utilities">Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.utilities.DotDict"><code class="docutils literal notranslate"><span class="pre">DotDict</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.utilities.Optics"><code class="docutils literal notranslate"><span class="pre">Optics</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.utilities.Timer"><code class="docutils literal notranslate"><span class="pre">Timer</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.utilities.get_max_knl_order"><code class="docutils literal notranslate"><span class="pre">get_max_knl_order()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.utilities.i_pow"><code class="docutils literal notranslate"><span class="pre">i_pow()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.utilities.is_anti_mirror_symmetric"><code class="docutils literal notranslate"><span class="pre">is_anti_mirror_symmetric()</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html#irnl_rdt_correction.utilities.log_setup"><code class="docutils literal notranslate"><span class="pre">log_setup()</span></code></a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">irnl-rdt-correction</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Nonlinear Correction calculation in the IRs</li>
      <li class="wy-breadcrumbs-aside">
              <!-- User defined GitHub URL -->
              <a href="https://github.com/pylhc/irnl_rdt_correction" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  <nav id="local-table-of-contents" role="navigation" aria-labelledby="local-table-of-contents-title">
    <h4 id="local-table-of-contents-title">On This Page</h4>
    <ul>
<li><a class="reference internal" href="#">Nonlinear Correction calculation in the IRs</a></li>
<li><a class="reference internal" href="#irnl_rdt_correction.main.irnl_rdt_correction"><code class="docutils literal notranslate"><span class="pre">irnl_rdt_correction()</span></code></a></li>
</ul>

  </nav>
  
  
           <div itemprop="articleBody">
             
  <span class="target" id="module-irnl_rdt_correction.main"></span><section id="nonlinear-correction-calculation-in-the-irs">
<h1>Nonlinear Correction calculation in the IRs<a class="headerlink" href="#nonlinear-correction-calculation-in-the-irs" title="Permalink to this heading"></a></h1>
<p>Performs local correction of the Resonance Driving Terms (RDTs)
in the Insertion Regions (IRs) based on the principle described in
<a class="reference internal" href="#bruningdynamicaperturestudies2004" id="id1"><span>[BruningDynamicApertureStudies2004]</span></a> with the addition of correcting
feed-down and using feed-down to correct lower order RDTs.
Details can be found in <a class="reference internal" href="#dillynonlinearircorrections2023" id="id2"><span>[DillyNonlinearIRCorrections2023]</span></a> .</p>
<div class="admonition-todo admonition" id="id3">
<p class="admonition-title">Todo</p>
<ul class="simple">
<li><p>[easy] Allow not giving errors (need to be <cite>None</cite> in list,
so that the list lengths are still the same and there is a
clear correspondence twiss-errors-beams).
Should then be assumed all zero.</p></li>
<li><p>[easy] Allow for more than two optics given
(e.g. find corrections for 15cm and 30cm for both beams)</p></li>
<li><p>[medium] Maybe sort RDTs by highest corrector instead of highest RDT order?
This should allow for correctors that correct via feed-down
to be assigned before lower order RDTs are calculated.
Might cause other problems, though. To be thought about.</p></li>
<li><p>[medium] Consider switching the signs all into the reference frame of Beam 1.
That means X, DX and anti-mirror-KN(S)L twiss and errors from Beam 4,
and the anti-mirror-KN(S)L twiss from Beam 2.
That should in principle allow to ignore all other beam-related sign switches.
BUT: does this really work with all the feed-down options implemented
(i.e. feed-down to RDT, feed-down from correctors)?
It should, but needs to be checked and tested.</p></li>
<li><p>[medium] Take phase advance between the elements and to the correction point
at the entrance of the IR into account.
That would mean correct the numerator of the actual RDT.</p></li>
<li><p>[hard] Additionally to taking the phase-advance into account, one might try to optimize
the actual RDTs at the position of the correctors. This might be very problematic,
as we have two correctors (one on each side) per order, so that might become a
non-linear problem (as now there are now two equations, one per corrector, which
are non-linearly dependent.)</p></li>
</ul>
</div>
<p class="rubric">References</p>
<dl class="citation">
<dt class="label" id="bruningdynamicaperturestudies2004"><span class="brackets"><a class="fn-backref" href="#id1">BruningDynamicApertureStudies2004</a></span></dt>
<dd><p>O. Bruening et al.,
Dynamic aperture studies for the LHC separation dipoles. (2004)
<a class="reference external" href="https://cds.cern.ch/record/742967">https://cds.cern.ch/record/742967</a></p>
</dd>
<dt class="label" id="dillynonlinearircorrections2023"><span class="brackets"><a class="fn-backref" href="#id2">DillyNonlinearIRCorrections2023</a></span></dt>
<dd><p>J. Dilly et R. Tomás,
A flexible nonlinear Resonance Driving Term based Correction Algorithm with feed-down. (2023)
<a class="reference external" href="https://github.com/pylhc/irnl_rdt_correction/blob/master/latex/note.pdf">https://github.com/pylhc/irnl_rdt_correction/blob/master/latex/note.pdf</a></p>
</dd>
</dl>
<p>author: Joschua Dilly</p>
</section>
<dl class="py function">
<dt class="sig sig-object py" id="irnl_rdt_correction.main.irnl_rdt_correction">
<span class="sig-prename descclassname"><span class="pre">irnl_rdt_correction.main.</span></span><span class="sig-name descname"><span class="pre">irnl_rdt_correction</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">opt</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><span class="pre">str</span><span class="p"><span class="pre">,</span></span><span class="w"> </span><span class="pre">TfsDataFrame</span><span class="p"><span class="pre">]</span></span></span></span><a class="reference internal" href="_modules/irnl_rdt_correction/main.html#irnl_rdt_correction"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#irnl_rdt_correction.main.irnl_rdt_correction" title="Permalink to this definition"></a></dt>
<dd><p>Get correctors and their optimal powering to minimize the given RDTs.</p>
<dl class="field-list simple">
<dt class="field-odd">Keyword Arguments</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>twiss</strong> (<em>list</em><em>[</em><em>str/Path/DataFrame</em><em>]</em>) -- Path(s) to twiss file(s) or DataFrame(s) of optics.
Needs to contain only the elements to be corrected
(e.g. only the ones in the IRs).
All elements from the error-files need to be present.
Required!</p></li>
<li><p><strong>errors</strong> (<em>list</em><em>[</em><em>str/Path/DataFrame</em><em>]</em>) -- Path(s) to error file(s) or DataFrame(s) of errors.
Can contain less elements than the optics files,
these elements are then assumed to have no errors.
Required!</p></li>
<li><p><strong>beams</strong> (<em>list</em><em>[</em><em>int</em><em>]</em>) -- Which beam the files come from (1, 2 or 4).
Required!</p></li>
<li><p><strong>output</strong> (<em>str/Path</em>) -- Path to write command and tfs_df file.
Extension (if given) is ignored and replaced with ‘.tfs’ and ‘.madx’
for the Dataframe and the command file respectively.
Default: <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>rdts</strong> (<em>list</em><em>[</em><em>str</em><em>]</em><em>, </em><em>dict</em><em>[</em><em>str</em><em>, </em><em>list</em><em>[</em><em>str</em><em>]</em>) -- RDTs to correct.
Format: ‘Fjklm’; or ‘Fjklm*’ to correct for
this RDT in Beam 2 using beta-symmetry (jk &lt;-&gt; lm).
The RDTs can be either given as a list, then the appropriate correctors
are determined by jklmn.
Alternatively, the input can be a dictionary,
where the keys are the RDT names as before, and the values are a list
of correctors to use, e.g. ‘b5’ for normal decapole corrector,
‘a3’ for skew sextupole, etc.
If the order of the corrector is higher than the order of the RDT,
the feed-down from the corrector is used for correction.
In the case where multiple orders of correctors are used,
increasing <code class="docutils literal notranslate"><span class="pre">iterations</span></code> might be useful.
Default: Standard RDTs for given <code class="docutils literal notranslate"><span class="pre">accel</span></code> (see <code class="docutils literal notranslate"><span class="pre">DEFAULT_RDTS</span></code> in this file).</p></li>
<li><p><strong>rdts2</strong> (<em>list</em><em>[</em><em>str</em><em>]</em><em>, </em><em>dict</em><em>[</em><em>str</em><em>, </em><em>list</em><em>[</em><em>str</em><em>]</em>) -- RDTs to correct for second beam/file, if different from first.
Same format rules as for <code class="docutils literal notranslate"><span class="pre">rdts</span></code>. Default: <code class="docutils literal notranslate"><span class="pre">None</span></code>.</p></li>
<li><p><strong>accel</strong> (<em>str</em>) -- Which accelerator we have. One of ‘lhc’, ‘hllhc’.
Default: <code class="docutils literal notranslate"><span class="pre">lhc</span></code>.</p></li>
<li><p><strong>feeddown</strong> (<em>int</em>) -- Order of Feeddown to include.
Default: <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p></li>
<li><p><strong>ips</strong> (<em>list</em><em>[</em><em>int</em><em>]</em>) -- In which IPs to correct.
Default: <code class="docutils literal notranslate"><span class="pre">[1,</span> <span class="pre">2,</span> <span class="pre">5,</span> <span class="pre">8]</span></code>.</p></li>
<li><p><strong>solver</strong> (<em>str</em>) -- Solver to use. One of ‘lstsq’, ‘inv’ or ‘linear’.
Default <code class="docutils literal notranslate"><span class="pre">lstsq</span></code>.</p></li>
<li><p><strong>update_optics</strong> (<em>bool</em>) -- Sorts the RDTs to start with the highest order
and updates the corrector strengths in the optics
after calculation, so the feeddown to lower order
correctors is included.
Default: <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p></li>
<li><p><strong>ignore_corrector_settings</strong> (<em>bool</em>) -- Ignore the current settings of the correctors.
If this is not set the corrector values of the
optics are used as initial conditions.
Default: <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
<li><p><strong>ignore_missing_columns</strong> (<em>bool</em>) -- If set, missing strength columns in any
of the input files are assumed to be
zero, instead of raising an error.
Default: <code class="docutils literal notranslate"><span class="pre">False</span></code>.</p></li>
<li><p><strong>iterations</strong> (<em>int</em>) -- (Re-)iterate correction, starting with the previously
calculated values. Needs to be &gt; 0, as the first calculation
counts as an iteration.
Default: <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>the string contains the madx-commands used to power the correctors;
the dataframe contains the same values in a pandas DataFrame.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>tuple[string, Dataframe]</p>
</dd>
</dl>
</dd></dl>



           </div>
          </div>

          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome the documentation of the IRNL RDT Correction!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="tools.html" class="btn btn-neutral float-right" title="Constants" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>